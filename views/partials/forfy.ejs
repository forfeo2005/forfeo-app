<div id="forfy-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: 'Segoe UI', sans-serif;">
    
    <div id="forfy-box" style="display:none; width:320px; height:450px; background:white; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,0.2); flex-direction:column; overflow:hidden; margin-bottom:15px; border:1px solid #eee;">
        <div style="background:#000; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            <span>ü§ñ Forfy Assistant</span>
            <span onclick="toggleForfy()" style="cursor:pointer; font-size:24px; line-height:20px;">&times;</span>
        </div>
        
        <div id="chat-content" style="flex:1; padding:15px; overflow-y:auto; font-size:14px; background:#fdfdfd; display:flex; flex-direction:column; gap:10px;">
            <div style="background:#eee; padding:10px; border-radius:10px; align-self:flex-start; max-width:80%;">
                Bonjour ! Je suis Forfy. Je peux vous aider √† analyser vos scores ou √† commander de nouvelles missions d'audit.
            </div>
        </div>

        <div style="padding:10px; border-top:1px solid #eee; display:flex; background:white;">
            <input type="text" id="chat-input" placeholder="Posez une question..." style="flex:1; border:1px solid #ddd; border-radius:20px; padding:10px 15px; outline:none; font-size:14px;">
            <button onclick="sendChat()" style="background:#000; color:white; border:none; margin-left:8px; width:35px; height:35px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">‚û§</button>
        </div>
    </div>

    <button onclick="toggleForfy()" style="width:60px; height:60px; border-radius:50%; background:#000; color:white; border:none; font-size:30px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; transition: transform 0.2s;">
        ü§ñ
    </button>
</div>

<script>
    function toggleForfy() {
        const box = document.getElementById('forfy-box');
        box.style.display = box.style.display === 'none' ? 'flex' : 'none';
        if(box.style.display === 'flex') {
            document.getElementById('chat-input').focus();
        }
    }

    async function sendChat() {
        const input = document.getElementById('chat-input');
        const content = document.getElementById('chat-content');
        const msg = input.value.trim();
        
        if(!msg) return;

        // Message utilisateur
        content.innerHTML += `
            <div style="background:#00aaff; color:white; padding:10px; border-radius:10px; align-self:flex-end; max-width:80%;">
                ${msg}
            </div>
        `;
        
        input.value = '';
        content.scrollTop = content.scrollHeight;

        // Message de chargement
        const loadingId = "loading-" + Date.now();
        content.innerHTML += `<div id="${loadingId}" style="font-size:12px; color:#aaa; font-style:italic;">Forfy r√©fl√©chit...</div>`;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            
            // Retirer chargement et afficher r√©ponse
            document.getElementById(loadingId).remove();
            content.innerHTML += `
                <div style="background:#eee; color:#333; padding:10px; border-radius:10px; align-self:flex-start; max-width:80%;">
                    ${data.reply}
                </div>
            `;
            content.scrollTop = content.scrollHeight;
        } catch (err) {
            document.getElementById(loadingId).innerHTML = "Erreur de connexion avec l'IA Forfeo.";
        }
    }

    document.getElementById('chat-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendChat();
    });
</script>
