<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Forfeo</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #ddd; }
        .stat-card h3 { margin: 0; color: #666; font-size: 14px; }
        .stat-card p { font-size: 24px; font-weight: bold; margin: 10px 0 0 0; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f8f8; color: #333; }
        .status { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-terminÃ©e { background: #d4edda; color: #155724; }
        .status-en-attente { background: #fff3cd; color: #856404; }
        .status-non-payÃ© { background: #f8d7da; color: #721c24; }
        .btn { background: #000; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; cursor: pointer; border:none; }
        .btn:hover { background: #333; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Bienvenue, <%= user.nom %></h1>
        <a href="/login" class="btn" style="background: #ccc; color: #333;">DÃ©connexion</a>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3>Score Forfeo</h3>
            <p><%= user.score %>/10</p>
        </div>
        <div class="stat-card">
            <h3>Missions Disponibles</h3>
            <p><%= user.missions_dispo %></p>
        </div>
        <div class="stat-card">
            <h3>Plan Actuel</h3>
            <p><%= user.plan %></p>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px;">
        <h2>Mes Missions d'Audit</h2>
        <a href="/new-mission?id=<%= user.id %>" class="btn">+ Nouvelle Mission (150$)</a>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Type de Mission</th>
                <th>Date souhaitÃ©e</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody>
            <% if (missions.length > 0) { %>
                <% missions.forEach(mission => { %>
                    <tr>
                        <td>#<%= mission.id %></td>
                        <td><%= mission.type_mission %></td>
                        <td><%= mission.date_souhaitee %></td>
                        <td>
                            <span class="status status-<%= mission.statut.toLowerCase().replace(/\s/g, '-') %>">
                                <%= mission.statut %>
                            </span>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="4" style="text-align: center; color: #888;">Aucune mission pour le moment.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<div id="forfy-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: 'Segoe UI', sans-serif;">
    
    <div id="forfy-chat-box" style="display: none; background: white; width: 320px; height: 450px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; margin-bottom: 15px; border: 1px solid #eee;">
        
        <div style="background: #000; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ðŸ¤–</span>
                <span>Forfy Assistant</span>
            </div>
            <span onclick="toggleForfy()" style="cursor: pointer; font-size: 20px;">&times;</span>
        </div>

        <div id="forfy-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #fdfdfd; font-size: 14px; line-height: 1.5;">
            <div style="margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 85%;">
                Bonjour <strong><%= user.nom %></strong> ! Je suis Forfy. Comment puis-je vous aider aujourd'hui ?
            </div>
        </div>

        <div style="padding: 12px; border-top: 1px solid #eee; display: flex; background: white;">
            <input type="text" id="forfy-input" placeholder="Posez une question..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
            <button onclick="askForfy()" style="background: #000; color: white; border: none; width: 35px; height: 35px; margin-left: 8px; border-radius: 50%; cursor: pointer;">âž¤</button>
        </div>
    </div>

    <button onclick="toggleForfy()" style="background: #000; color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
        ðŸ¤–
    </button>
</div>

<script>
    function toggleForfy() {
        const box = document.getElementById('forfy-chat-box');
        box.style.display = box.style.display === 'none' ? 'flex' : 'none';
        if(box.style.display === 'flex') document.getElementById('forfy-input').focus();
    }

    document.getElementById('forfy-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') askForfy();
    });

    async function askForfy() {
        const input = document.getElementById('forfy-input');
        const messages = document.getElementById('forfy-messages');
        const question = input.value.trim();
        
        if (!question) return;

        messages.innerHTML += `<div style="text-align: right; margin-bottom: 15px;"><div style="display: inline-block; background: #000; color: white; padding: 10px; border-radius: 10px 10px 0 10px; max-width: 85%;">${question}</div></div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        const loadingId = 'loading-' + Date.now();
        messages.innerHTML += `<div id="${loadingId}" style="margin-bottom: 15px; color: #888; font-style: italic; font-size: 12px;">Forfy rÃ©flÃ©chit...</div>`;
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question })
            });
            const data = await response.json();
            document.getElementById(loadingId).remove();
            messages.innerHTML += `<div style="margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 85%;">${data.reply}</div>`;
            messages.scrollTop = messages.scrollHeight;
        } catch (error) {
            document.getElementById(loadingId).innerHTML = "Erreur de connexion avec Forfy. ðŸ”Œ";
        }
    }
</script>

</body>
</html>
