<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard | FORFEO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
        .admin-card { background: white; border-radius: 15px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; }
        .table th { font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container-fluid py-4 px-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark">Super Admin Dashboard</h3>
            <div class="d-flex gap-2">
                <a href="/admin/rapport-comptable" class="btn btn-dark btn-sm rounded-pill px-3">Comptabilit√©</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm rounded-pill px-3">D√©connexion</a>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                
                <div class="admin-card border-warning border-start border-5">
                    <h5 class="fw-bold mb-3 text-warning">1. Rapports √† Approuver (Statut: Soumis)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Mission</th><th>Entreprise</th><th>Ambassadeur</th><th>Action</th></tr></thead>
                            <tbody>
                                <% const toApprove = missions.filter(m => m.statut === 'soumis'); %>
                                <% if(toApprove.length > 0) { %>
                                    <% toApprove.forEach(m => { %>
                                        <tr>
                                            <td><%= m.titre %></td>
                                            <td><%= m.entreprise_nom %></td>
                                            <td><%= m.ambassadeur_nom || 'N/A' %></td>
                                            <td>
                                                <div class="d-flex gap-2">
                                                    <a href="/admin/rapport/<%= m.id %>" class="btn btn-sm btn-outline-primary" target="_blank">Voir</a>
                                                    <form action="/admin/approuver-mission" method="POST">
                                                        <input type="hidden" name="id_mission" value="<%= m.id %>">
                                                        <button class="btn btn-sm btn-success fw-bold">Approuver ‚úÖ</button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td colspan="4" class="text-muted text-center py-3">Aucun rapport en attente.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card border-success border-start border-5">
                    <h5 class="fw-bold mb-3 text-success">2. Paiements √† effectuer (Statut: Approuv√©)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Mission</th><th>Montant</th><th>Action</th></tr></thead>
                            <tbody>
                                <% const toPay = missions.filter(m => m.statut === 'approuve' && m.statut_paiement === 'non_paye'); %>
                                <% if(toPay.length > 0) { %>
                                    <% toPay.forEach(m => { %>
                                        <tr>
                                            <td><%= m.titre %></td>
                                            <td class="fw-bold text-success"><%= m.recompense %></td>
                                            <td>
                                                <form action="/admin/payer-ambassadeur" method="POST">
                                                    <input type="hidden" name="id_mission" value="<%= m.id %>">
                                                    <button class="btn btn-sm btn-outline-success rounded-pill px-3">Marquer Pay√© üíµ</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td colspan="3" class="text-muted text-center py-3">Tout est pay√©.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h5 class="fw-bold mb-3">Vue d'ensemble Missions</h5>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>ID</th><th>Titre</th><th>Statut</th><th>Date</th></tr></thead>
                            <tbody>
                                <% missions.forEach(m => { %>
                                    <tr>
                                        <td>#<%= m.id %></td>
                                        <td><%= m.titre %></td>
                                        <td><span class="badge bg-secondary"><%= m.statut %></span></td>
                                        <td><%= new Date(m.created_at).toLocaleDateString() %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="admin-card bg-primary text-white">
                    <h5 class="fw-bold mb-4">Finance (√Ä Payer)</h5>
                    <h1 class="display-4 fw-bold mb-0"><%= totalAPayer %>$</h1>
                    <p class="opacity-75">Montant total d√ª aux ambassadeurs</p>
                </div>

                <div class="admin-card">
                    <h5 class="fw-bold mb-3">Cr√©er un utilisateur</h5>
                    <form action="/admin/create-user" method="POST">
                        <div class="mb-2"><input type="text" name="nom" class="form-control" placeholder="Nom" required></div>
                        <div class="mb-2"><input type="email" name="email" class="form-control" placeholder="Email" required></div>
                        <div class="mb-2"><input type="password" name="password" class="form-control" placeholder="Mot de passe" required></div>
                        <div class="mb-3">
                            <select name="role" class="form-select">
                                <option value="admin">Admin</option>
                                <option value="entreprise">Entreprise</option>
                                <option value="ambassadeur">Ambassadeur</option>
                            </select>
                        </div>
                        <button class="btn btn-dark w-100">Cr√©er</button>
                    </form>
                </div>

                <div class="admin-card">
                    <h5 class="fw-bold mb-3">Utilisateurs r√©cents</h5>
                    <ul class="list-group list-group-flush">
                        <% users.slice(0, 5).forEach(u => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <strong><%= u.nom %></strong><br>
                                    <small class="text-muted"><%= u.role %></small>
                                </div>
                                <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Supprimer ?');">
                                    <input type="hidden" name="user_id" value="<%= u.id %>">
                                    <button class="btn btn-sm text-danger"><i class="bi bi-trash"></i></button>
                                </form>
                            </li>
                        <% }) %>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
