<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | FORFEO LAB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --admin-purple: #6366f1; --bg-soft: #f8fafc; }
        body { background-color: var(--bg-soft); font-family: 'Inter', sans-serif; }
        
        .navbar-admin { background: #1e293b; color: white; padding: 15px 25px; }
        .stat-card { border: none; border-radius: 16px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        
        /* OPTIMISATION MOBILE POUR LES RAPPORTS */
        @media (max-width: 768px) {
            .table-responsive-mobile thead { display: none; }
            .table-responsive-mobile tr { 
                display: block; 
                background: white; 
                margin-bottom: 15px; 
                border-radius: 15px; 
                padding: 15px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }
            .table-responsive-mobile td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                border: none !important; 
                padding: 8px 0;
                font-size: 0.9rem;
            }
            .table-responsive-mobile td::before { 
                content: attr(data-label); 
                font-weight: 700; 
                color: #64748b; 
            }
            .btn-mobile-full { width: 100%; margin-top: 10px; }
        }

        .status-badge { font-size: 0.75rem; font-weight: 700; padding: 5px 12px; border-radius: 50px; }
    </style>
</head>
<body>

    <nav class="navbar-admin d-flex justify-content-between align-items-center sticky-top shadow">
        <div class="d-flex align-items-center">
            <i class="bi bi-shield-lock-fill me-2 text-warning"></i>
            <span class="fw-bold">FORFEO ADMIN</span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="small d-none d-md-inline">Bonjour, <%= userName %></span>
            <a href="/logout" class="btn btn-danger btn-sm rounded-pill px-3">Déconnexion</a>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-white p-3 shadow-sm border-start border-primary border-4">
                    <div class="text-muted small fw-bold">ENTREPRISES</div>
                    <div class="fs-3 fw-bold"><%= entreprises.length %></div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-white p-3 shadow-sm border-start border-success border-4">
                    <div class="text-muted small fw-bold">RAPPORTS</div>
                    <div class="fs-3 fw-bold"><%= rapports.length %></div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="card stat-card bg-dark text-white p-3 shadow-sm">
                    <div class="text-warning small fw-bold">REVENUS GÉNÉRÉS (6 MOIS)</div>
                    <canvas id="revenueChart" style="max-height: 40px;"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 p-3">
                    <h6 class="fw-bold mb-3"><i class="bi bi-buildings me-2"></i>Entreprises</h6>
                    <ul class="list-group list-group-flush">
                        <% entreprises.forEach(e => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 border-light">
                                <div>
                                    <div class="fw-bold small"><%= e.nom %></div>
                                    <div class="text-muted" style="font-size: 0.7rem;"><%= e.email %></div>
                                </div>
                                <span class="badge <%= e.forfait === 'Premium' ? 'bg-primary' : 'bg-secondary' %> rounded-pill">
                                    <%= e.forfait %>
                                </span>
                            </li>
                        <% }) %>
                    </ul>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 p-3">
                    <h6 class="fw-bold mb-3"><i class="bi bi-check2-circle me-2"></i>Flux des Rapports</h6>
                    <div class="table-responsive">
                        <table class="table table-responsive-mobile align-middle">
                            <thead class="text-muted small">
                                <tr>
                                    <th>MISSION / ENTREPRISE</th>
                                    <th>PREUVE</th>
                                    <th>STATUT</th>
                                    <th class="text-end">ACTION</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% rapports.forEach(r => { %>
                                    <tr>
                                        <td data-label="Mission">
                                            <div class="fw-bold text-dark"><%= r.titre %></div>
                                            <div class="text-muted small">Client: <%= r.entreprise_nom || 'N/A' %></div>
                                        </td>
                                        <td data-label="Preuve">
                                            <% if(r.photo_preuve) { %>
                                                <a href="<%= r.photo_preuve %>" target="_blank" class="btn btn-sm btn-outline-info rounded-pill">
                                                    <i class="bi bi-image"></i> Voir
                                                </a>
                                            <% } else { %>
                                                <span class="text-muted small">Aucune</span>
                                            <% } %>
                                        </td>
                                        <td data-label="Statut">
                                            <span class="status-badge <%= r.statut === 'approuve' ? 'bg-success-subtle text-success' : 'bg-warning-subtle text-warning' %>">
                                                <%= r.statut.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td data-label="Action" class="text-end">
                                            <% if(r.statut === 'termine') { %>
                                                <form action="/admin/approuver-mission" method="POST" class="d-inline">
                                                    <input type="hidden" name="id_mission" value="<%= r.id %>">
                                                    <button type="submit" class="btn btn-success btn-sm rounded-pill btn-mobile-full">
                                                        <i class="bi bi-check-lg"></i> Valider
                                                    </button>
                                                </form>
                                            <% } else { %>
                                                <i class="bi bi-shield-check text-success"></i>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Graphique de revenus simplifié pour l'admin
        const ctx = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: <%- JSON.stringify(chartData.map(d => d.mois)) %>,
                datasets: [{
                    label: 'Revenus ($)',
                    data: <%- JSON.stringify(chartData.map(d => d.total)) %>,
                    borderColor: '#fbbf24',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
